<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Avdecc-lib : Simple C++ library for implementing IEEE1722.1 (AVB Device Enumeration, Discovery and Control)">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Avdecc-lib</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/audioscience/avdecc-lib">View on GitHub</a>

          <h1 id="project_title">Avdecc-lib</h1>
          <h2 id="project_tagline">Simple C++ library for implementing IEEE1722.1 (AVB Device Enumeration, Discovery and Control)</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/audioscience/avdecc-lib/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/audioscience/avdecc-lib/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a id="avdecc-lib" class="anchor" href="#avdecc-lib" aria-hidden="true"><span class="octicon octicon-link"></span></a>avdecc-lib</h1>

<p>Simple C++ library for implementing IEEE1722.1 (AVB Device Enumeration, Discovery and Control).</p>

<h2>
<a id="introduction" class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h2>

<p>This library aims to simplify development of an AVDECC Controller based on the IEEE1722.1 specification.
It provides a simple C++ object interface to 1722.1 objects and implements device discovery and enumeration
as a background process.</p>

<p>The repository contains source to build a Windows DLL or a Linux library and a command line application for
exercising the library.</p>

<p>The overall philosophy of AVDECC LIB is to implement a thin layer of commands that allow an application to
discover and control AVDECC capable End Stations. The internal operations of the library are designed to be single threaded,
although multiple threads are used to queue operations to be performed by the single threaded "engine" portion of the library.
The library supports notification events (callbacks) that are triggered on the success (or failure) of a command. 
It is up to the application to process the notifications in a useful manner. Asynchronous descriptor updates from an
End Station are also supported. A descriptor notification does not have data about the updated descriptor values embedded
in it. Instead the AVDECC application should query the descriptor class to obtain the updated values.</p>

<p>Operations that "fetch" details or status of an End Station store the response for later readback by the controller application.
An example of this would be the AEM send_get_stream_info_cmd() operation whose response is stored in the appropriate stream input object in avdecc-lib.
Functions get_stream_info_msrp_accumulated_latency(), get_stream_info_msrp_failure_code() and others can then be used to readback fields of the response.</p>

<p>Users developing 1722.1 end stations and controllers are encouraged to add new descriptors to this library as required.
The library provides an easy entry point for adding and testing a completely new 1722.1 descriptor without having
to develop a complete controller side 1722.1 software stack.</p>

<h2>
<a id="dependencies" class="anchor" href="#dependencies" aria-hidden="true"><span class="octicon octicon-link"></span></a>Dependencies</h2>

<p>Uses Jeff Koftinoff's packet processing library, see <a href="https://github.com/jdkoftinoff/jdksavdecc-c.git">https://github.com/jdkoftinoff/jdksavdecc-c.git</a>
This is a submodule that can be cloned using:</p>

<pre><code>cd avdecc-lib
git submodule init
git submodule update
</code></pre>

<p>As of March 2014, avdecc-lib is following the master branch of jdksavdecc-c (from github).</p>

<h2>
<a id="acknowledgements" class="anchor" href="#acknowledgements" aria-hidden="true"><span class="octicon octicon-link"></span></a>Acknowledgements</h2>

<p>Special thanks are owed to Jeff Koftinoff for creating and releasing public source for 1722.1 packet processing in
the jdksavdecc-c library and for comments and advice freely given during the development of this library. This C++
library is a rather thin wrapper around functions already present in the jdksavdecc-c library.</p>

<h2>
<a id="community" class="anchor" href="#community" aria-hidden="true"><span class="octicon octicon-link"></span></a>Community</h2>

<p>Please join Google Group "avdecc-lib" if you wish to comment on avdecc-lib, or keep track of discussions.</p>

<h2>
<a id="directory-layout" class="anchor" href="#directory-layout" aria-hidden="true"><span class="octicon octicon-link"></span></a>Directory layout</h2>

<pre><code>controller\ 
    lib\
        bin\
        doc\
        binding\
            python\
        include\ (contains public header files)
        src\ (contains private header files and C++ source code)
            linux\ (linux specific files)
            msvc\ (Microsoft Visual Studio specific files)

    app\
        bin\
        doc\
        cmdline\
            src\
        test\
            strings\
            adp\
            logging\ 
            notify\     
</code></pre>

<h2>
<a id="object-hierarchy" class="anchor" href="#object-hierarchy" aria-hidden="true"><span class="octicon octicon-link"></span></a>Object hierarchy</h2>

<pre><code>System
Controller
    End Station[1..N]
        Entity[1..N]
            Configuration[1..N]
                Audio Unit[1..N]
                        Stream Port Input[0..N]
                                    Audio Cluster[0..N]
                                    Audio Map[0..N]
                                    Control[0..N]
                        Stream Port Output[0..N]
                                    Audio Cluster[0..N]
                                    Audio Map[0..N]
                                    Control[0..N]
                        External Port Input[0..N]
                        External Port Output[0..N]
                        Internal Port Input[0..N]
                        Internal Port Output[0..N]
                        Control[0..N]
                        Signal Selector[0..N]
                        Mixer[0..N]
                        Matrices[0..N]
                        Splitter[0..N]
                        Combiner[0..N]
                        Demultiplexer[0..N]
                        Transcoder[0..N]
                        Control Block[0..N]
                Stream Input[1..N]
                Stream Output[1..N]
                Jack Input[1..N]
                Jack Output[1..N]
                AVB Interface[1..N]
                Clock Source[1..N]
                Clock Domain[1..N]
</code></pre>

<h2>
<a id="building" class="anchor" href="#building" aria-hidden="true"><span class="octicon octicon-link"></span></a>Building</h2>

<p>All build environments require</p>

<ol>
<li>cmake v2.8</li>
</ol>

<p>Run cmake to create the build dirctories for your environment.</p>

<pre><code>cd avdecc-lib
cmake .
</code></pre>

<h3>
<a id="windows" class="anchor" href="#windows" aria-hidden="true"><span class="octicon octicon-link"></span></a>Windows</h3>

<p>Prerequisites</p>

<ol>
<li>MSVC 2013 or later</li>
<li>winpcap development package from <a href="http://www.winpcap.org/devel.htm">http://www.winpcap.org/devel.htm</a>
</li>
</ol>

<p>The following environment variables must be defined:</p>

<ul>
<li>WPCAP_DIR the directory where WinPcap is installed</li>
</ul>

<p>Get the lib from github:</p>

<ul>
<li>Make and enter the project directory</li>
<li>git clone git://github.com/audioscience/avdecc-lib</li>
<li>cd avdecc-lib</li>
<li>git submodule init</li>
<li>Edit in .git/config, change url = <a href="mailto:git@github.com">git@github.com</a>:jdkoftinoff/jdksavdecc-c.git to url = git ://github.com/jdkoftinoff/jdksavdecc-c.git</li>
<li>git submodule update</li>
</ul>

<p>Compile</p>

<ul>
<li>Open command window to "project folder" AVDECC-Lib</li>
<li>Initialize compiler environment : "C:\Program Files (x86)\Microsoft Visual Studio 12.0\VC\vcvarsall.bat" x86</li>
<li>cmake .</li>
<li>msbuild ALL_BUILD.vcxproj</li>
<li>cd controller</li>
<li>cmake .</li>
<li>msbuild ALL_BUILD.vcxproj</li>
</ul>

<p>Run</p>

<ul>
<li>controller.dll located in : AVDECC-Lib\avdecc-lib\controller\lib\Debug</li>
<li>command line app located in : AVDECC-Lib\avdecc-lib\controller\app\cmdline\Debug</li>
<li>Copy controller.dll to app folder</li>
<li>Run application</li>
</ul>

<h3>
<a id="linux" class="anchor" href="#linux" aria-hidden="true"><span class="octicon octicon-link"></span></a>Linux</h3>

<p>Prerequisites</p>

<ol>
<li>gcc development environment (v4.8 or later)</li>
<li>libedit</li>
<li>readline library, may need to go "sudo apt-get install libreadline5-dev"</li>
</ol>

<h3>
<a id="osx" class="anchor" href="#osx" aria-hidden="true"><span class="octicon octicon-link"></span></a>OSX</h3>

<p>Prerequisites: cmake installed (<a href="http://www.cmake.org/">http://www.cmake.org/</a>):</p>

<p>Get the lib from github:</p>

<ul>
<li>Make and enter the project directory</li>
<li>git clone git://github.com/audioscience/avdecc-lib --recursive</li>
</ul>

<p>Compile</p>

<ul>
<li>cd avdecc-lib</li>
<li>cmake .</li>
<li>make</li>
</ul>

<h1>
<a id="operations" class="anchor" href="#operations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Operations</h1>

<h2>
<a id="avdecc-controller-version" class="anchor" href="#avdecc-controller-version" aria-hidden="true"><span class="octicon octicon-link"></span></a>AVDECC Controller version</h2>

<p>The AVDECC Controller version number can be updated inside the version header file.</p>

<h2>
<a id="avdecc-end-station-discovery" class="anchor" href="#avdecc-end-station-discovery" aria-hidden="true"><span class="octicon octicon-link"></span></a>AVDECC End Station Discovery</h2>

<p>When the AVDECC system receives an AVDECC advertise message from an End Station, it proceeds to
enumerate the End Station's complete object model, if it has not done so already. Upon completion
of the enumeration process, a notification message is sent to the application.</p>

<h2>
<a id="avdecc-aem-descriptor-reads" class="anchor" href="#avdecc-aem-descriptor-reads" aria-hidden="true"><span class="octicon octicon-link"></span></a>AVDECC AEM descriptor reads</h2>

<p>A descriptor read by referencing the object the object of interest. Since the AVDECC system has
already read all descriptors, the read operation is completed without producing any network traffic.</p>

<p>To read the name of the first input jack, one would go:</p>

<pre><code>controller-&gt;end_station(0)-&gt;entity(0)-&gt;configuration(0)-&gt;input_stream(0)-&gt;get_name(name)
</code></pre>

<h2>
<a id="avdecc-aem-commands" class="anchor" href="#avdecc-aem-commands" aria-hidden="true"><span class="octicon octicon-link"></span></a>AVDECC AEM commands</h2>

<p>An AVDECC command is sent to the target object, ie:</p>

<pre><code>istream = controller-&gt;end_station(0)-&gt;entity(0)-&gt;configuration(0)-&gt;input_stream(0);
id = (void *)notify_id;
// put the notify_id value in a list somewhere
istream-&gt;set_format(id, format,...);
notify_id++;
</code></pre>

<p>Completion results in a notification message of success or failure via the callback mechanism. An alternative calling
sequence is to wait for the callback to complete in-line, ie:</p>

<pre><code>id = (void *)notify_id;
avdecc_system-&gt;set_wait_for_next_cmd(id);
istream = controller-&gt;end_station(0)-&gt;entity(0)-&gt;configuration(0)-&gt;input_stream(0);
istream-&gt;set_format(id, format,...);
status = avdecc_system-&gt;get_last_resp_status();
notify_id++;
</code></pre>

<p>The above examples place an uint32_t notify_id in a "void *" container. If the application writer is careful about
object creation and destruction, they may choose to place a C++ (or other language) object in the notify_id field.</p>

<h2>
<a id="callbacks" class="anchor" href="#callbacks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Callbacks</h2>

<p>The following callback functions should be supplied. If NULL is passed in for the callback function, no callback will be invoked.</p>

<pre><code>void log_callback(void *log_user_obj, int32_t log_level, const char *log_msg, int32_t time_stamp_ms);
void notification_callback(void *notification_user_obj, int32_t notification_type, uint64_t guid, uint16_t cmd_type, uint16_t desc_type, uint16_t desc_index, void *notification_id);
</code></pre>

<p>When a controller internal thread calls the log_callback function that was invoked at controller create time,
the log_user_obj pointer that was passed in at that time is returned in the callback. The calling application
code use this void pointer to store a C++ class if that was helpful to the structure of the calling application.
The log_callback is called with log_level values of:</p>

<ul>
<li>ERROR</li>
<li>WARNING</li>
<li>NOTICE</li>
<li>INFO</li>
<li>DEBUG</li>
<li>VERBOSE</li>
</ul>

<p>Like the log_callback function the notification callback returns a void "user" pointers as the first field in the callback.
The notification_callback is called with notification_type values of:</p>

<ul>
<li>NO MATCH FOUND</li>
<li>END STATION CONNECTED</li>
<li>END STATION DISCONNECTED,</li>
<li>COMMAND TIMEOUT</li>
<li>RESPONSE RECEIVED</li>
<li>END_STATION_READ_COMPLETED</li>
</ul>

<h2>
<a id="source-code-style" class="anchor" href="#source-code-style" aria-hidden="true"><span class="octicon octicon-link"></span></a>Source code style</h2>

<p>Source code is auto-formatted using the astyle formatting tool. All submitted pull requests should be passed through astyle
before the pull request is issued. The format to use is specified in the astyle_code_format option file in this
directory. asytle is run from the command line using the following command sequence:</p>

<pre><code>AStyle --options=..\avdecc-lib\astyle_code_style.txt ..\avdecc-lib\controller\lib\include\*.h
         ..\avdecc-lib\controller\lib\src\*.h ..\avdecc-lib\controller\lib\src\*.cpp
         ..\avdecc-lib\controller\lib\src\msvc\*.h ..\avdecc-lib\controller\lib\src\msvc\*.cpp
</code></pre>

<h2>
<a id="source-documentation" class="anchor" href="#source-documentation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Source documentation</h2>

<p>A standard tool, Doxygen, is used for generating documentation from the AVDECC Controller Lib source code.
A link to the online version of the AVDECC Controller Lib documentation can be found at:
<a href="http://www.audioscience.com/internet/download/sdk/avdecclib_usermanual_html/html/index.html">http://www.audioscience.com/internet/download/sdk/avdecclib_usermanual_html/html/index.html</a></p>

<h1>
<a id="development-conventions" class="anchor" href="#development-conventions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Development Conventions</h1>

<p>Developers should add new features to the <em>staging</em> git branch. Periodically the <em>staging</em> git branch
will be merged to the <em>master</em> branch.</p>

<p><img src="git_dev_seq_uml.png" alt=""></p>

<h1>
<a id="roadmap" class="anchor" href="#roadmap" aria-hidden="true"><span class="octicon octicon-link"></span></a>Roadmap</h1>

<p>Working towards release version 1.0.0.</p>

<p>Release 1.0.0 supports:</p>

<ul>
<li>all of the P1 Command/responses listed below.</li>
<li>Windows, linux and OSX builds.</li>
</ul>

<p>Future features include:</p>

<ul>
<li>security key passing</li>
<li>Layer 3 (IP)  interface</li>
<li>other descriptors as required</li>
</ul>

<h1>
<a id="status" class="anchor" href="#status" aria-hidden="true"><span class="octicon octicon-link"></span></a>Status</h1>

<table>
<thead>
<tr>
<th>Command/Response</th>
<th>Priority</th>
<th>Implemented</th>
<th>Tested</th>
</tr>
</thead>
<tbody>
<tr>
<td>ACQUIRE_ENTITY</td>
<td>P1</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>LOCK_ENTITY</td>
<td>P1</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>ENTITY_AVAILABLE</td>
<td>P1</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>CONTROLLER_AVAILABLE</td>
<td>P1</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>READ_DESCRIPTOR</td>
<td>P1</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>SET_STREAM_FORMAT</td>
<td>P1</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>GET_STREAM_FORMAT</td>
<td>P1</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>SET_STREAM_INFO</td>
<td>P1</td>
<td></td>
<td></td>
</tr>
<tr>
<td>GET_STREAM_INFO</td>
<td>P1</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>SET_SAMPLING_RATE</td>
<td>P1</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>GET_SAMPLING_RATE</td>
<td>P1</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>SET_CLOCK_SOURCE</td>
<td>P1</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>GET_CLOCK_SOURCE</td>
<td>P1</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>START_STREAMING</td>
<td>P1</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>STOP_STREAMING</td>
<td>P1</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>SET_CONFIGURATION</td>
<td>P2</td>
<td></td>
<td></td>
</tr>
<tr>
<td>GET_CONFIGURATION</td>
<td>P2</td>
<td></td>
<td></td>
</tr>
<tr>
<td>SET_CONTROL</td>
<td>P2</td>
<td></td>
<td></td>
</tr>
<tr>
<td>GET_CONTROL</td>
<td>P2</td>
<td></td>
<td></td>
</tr>
<tr>
<td>SET_NAME</td>
<td>P2</td>
<td></td>
<td></td>
</tr>
<tr>
<td>GET_NAME</td>
<td>P2</td>
<td></td>
<td></td>
</tr>
<tr>
<td>SET_MIXER</td>
<td>P2</td>
<td></td>
<td></td>
</tr>
<tr>
<td>GET_MIXER</td>
<td>P2</td>
<td></td>
<td></td>
</tr>
<tr>
<td>REGISTER_UNSOLICITED_NOTIFICATION</td>
<td>P2</td>
<td></td>
<td></td>
</tr>
<tr>
<td>DEREGISTER_UNSOLICITED_NOTIFICATION</td>
<td>P2</td>
<td></td>
<td></td>
</tr>
<tr>
<td>IDENTIFY_NOTIFICATION</td>
<td>P2</td>
<td></td>
<td></td>
</tr>
<tr>
<td>GET_AVB_INFO</td>
<td>P2</td>
<td></td>
<td></td>
</tr>
<tr>
<td>GET_AS_PATH</td>
<td>P2</td>
<td></td>
<td></td>
</tr>
<tr>
<td>REBOOT</td>
<td>P2</td>
<td></td>
<td></td>
</tr>
<tr>
<td>WRITE_DESCRIPTOR</td>
<td>P3</td>
<td></td>
<td></td>
</tr>
<tr>
<td>SET_ASSOCIATION_ID</td>
<td>P3</td>
<td></td>
<td></td>
</tr>
<tr>
<td>GET_ASSOCIATION_ID</td>
<td>P3</td>
<td></td>
<td></td>
</tr>
<tr>
<td>INCREMENT_CONTROL</td>
<td>P3</td>
<td></td>
<td></td>
</tr>
<tr>
<td>DECREMENT_CONTROL</td>
<td>P3</td>
<td></td>
<td></td>
</tr>
<tr>
<td>SET_SIGNAL_SELECTOR</td>
<td>P3</td>
<td></td>
<td></td>
</tr>
<tr>
<td>GET_SIGNAL_SELECTOR</td>
<td>P3</td>
<td></td>
<td></td>
</tr>
<tr>
<td>SET_MATRIX</td>
<td>P3</td>
<td></td>
<td></td>
</tr>
<tr>
<td>GET_MATRIX</td>
<td>P3</td>
<td></td>
<td></td>
</tr>
<tr>
<td>GET_COUNTERS</td>
<td>P3</td>
<td></td>
<td></td>
</tr>
<tr>
<td>GET_AUDIO_MAP</td>
<td>P3</td>
<td></td>
<td></td>
</tr>
<tr>
<td>ADD_AUDIO_MAPPINGS</td>
<td>P3</td>
<td></td>
<td></td>
</tr>
<tr>
<td>REMOVE_AUDIO_MAPPINGS</td>
<td>P3</td>
<td></td>
<td></td>
</tr>
<tr>
<td>START_OPERATION</td>
<td>P3</td>
<td></td>
<td></td>
</tr>
<tr>
<td>ABORT_OPERATION</td>
<td>P3</td>
<td></td>
<td></td>
</tr>
<tr>
<td>OPERATION_STATUS</td>
<td>P3</td>
<td></td>
<td></td>
</tr>
<tr>
<td>SET_VIDEO_FORMAT</td>
<td>P4</td>
<td></td>
<td></td>
</tr>
<tr>
<td>GET_VIDEO_FORMAT</td>
<td>P4</td>
<td></td>
<td></td>
</tr>
<tr>
<td>SET_SENSOR_FORMAT</td>
<td>P4</td>
<td></td>
<td></td>
</tr>
<tr>
<td>GET_SENSOR_FORMAT</td>
<td>P4</td>
<td></td>
<td></td>
</tr>
<tr>
<td>GET_VIDEO_MAP</td>
<td>P4</td>
<td></td>
<td></td>
</tr>
<tr>
<td>ADD_VIDEO_MAPPINGS</td>
<td>P4</td>
<td></td>
<td></td>
</tr>
<tr>
<td>REMOVE_VIDEO_MAPPINGS</td>
<td>P4</td>
<td></td>
<td></td>
</tr>
<tr>
<td>GET_SENSOR_MAP</td>
<td>P4</td>
<td></td>
<td></td>
</tr>
<tr>
<td>ADD_SENSOR_MAPPINGS</td>
<td>P4</td>
<td></td>
<td></td>
</tr>
<tr>
<td>REMOVE_SENSOR_MAPPINGS</td>
<td>P4</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h4>
<a id="todo" class="anchor" href="#todo" aria-hidden="true"><span class="octicon octicon-link"></span></a>ToDo</h4>

<h1>
<a id="release-notes" class="anchor" href="#release-notes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Release Notes</h1>

<p>None so far.</p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Avdecc-lib maintained by <a href="https://github.com/audioscience">audioscience</a></p>
        <p>Published with <a href="https://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
